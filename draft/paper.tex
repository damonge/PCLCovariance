\documentclass[useAMS,usenatbib]{mn2e}
\bibliographystyle{mn2e}
\pdfoutput=1
\pdfminorversion=5

%\usepackage{widetext}
\usepackage{graphicx}
\usepackage{dcolumn}
\usepackage{bm}
\usepackage{amssymb,amsmath,bm}
\usepackage{color}
\usepackage[dvipsnames]{xcolor}
\usepackage[colorlinks,linkcolor=red,citecolor=blue,urlcolor=blue ]{hyperref}
\usepackage{multirow}
\usepackage[utf8]{inputenc}
\usepackage{balance}
\usepackage{enumitem}
\usepackage{lipsum}
\newcommand{\nv}{\hat{\bf n}}
\newcommand{\kalo}{Karhunen-Lo\`{e}ve~}
\newcommand{\cfh}{CFHTLenS~}
\newcommand{\jcap}{JCAP}
\newcommand{\mnras}{MNRAS}
\newcommand{\aap}{A\&A}
\newcommand{\aaps}{A\&AS}
\newcommand{\apjs}{ApJS}
\newcommand{\apj}{ApJ}
\newcommand{\apjl}{ApJL}
\newcommand{\prd}{Phys.~Rev.~D}
\newcommand{\prl}{Phys.~Rev.~Lett.}
\newcommand{\aj}{Astron. Journal}
\newcommand{\pasp}{Publications of the ASP}
\newcommand{\nar}{New Astronomy Review}
\newcommand{\procspie}{Proceedings of the SPIE}
\newcommand{\physrep}{Physics Reports}

\newcommand{\todo}[1]{{\bf TODO: #1}}
%\newcommand{\todo}[1]{$\,$}

\newcommand{\pcl}[3]{\hat C_{#1}^{#2 #3}}
\newcommand{\avg}[1]{\langle #1 \rangle}
\newcommand{\fsky}{f_{\mbox{sky}}}
\newcommand{\clth}{C_l^{th}}
\newcommand{\clf}{C_l^{fore}}
\newcommand{\cl}{C_l}


\title[Reliable analytic approximation of pseudo-$\cl$ covariances]{Reliable analytic approximation of pseudo-$\cl$ covariances}
\author[C. Garc\'{i}a-Garc\'{i}a et al.]{Carlos Garc\'{i}a-Garc\'{i}a$^{1,\,2}$\thanks{carlosgarcia@iff.csic.es}, David Alonso$^2$\thanks{david.alonso@physics.ox.ac.uk}, Emilio Bellini$^2$\thanks{emilio.bellini@physics.ox.ac.uk}\\
$^{1}$ Instituto de Física Fundamental, Consejo Superior de Investigaciones
Científicas, c/. Serrano 123, E–28006, Madrid, Spain\\
$^{2}$Oxford Astrophysics, Department of Physics, Keble Road, Oxford, OX1 3RH, UK
}

\begin{document}
  \date{\today}
  \pagerange{1--18} \pubyear{2019}
  \maketitle

\begin{abstract}
\end{abstract}

\begin{keywords}
  cosmology: large-scale structure of the Universe -- methods: data analysis
\end{keywords}

\section{Introduction}
    
\section{Analytical Covariance}
This section presents the analytical calculation of the pseudo-$C_\ell$ covariance. The treatment and approximations used are similar to those presented in \todo{cite} for spin-0 quantities, in \todo{cite} for particular spin-0 and spin-2 correlations and in \todo{cite} for the 3D density field. We reproduce the formalism here in order to provide a complete set of formulas applicable to any cross-correlation in both curved and flat skies.



\begin{itemize}
\item Naive Covariance
  \begin{equation}
    C^{abcd} = \frac{\pcl{l}ad \pcl{l}bc + \pcl{l}ac \pcl{l}bd}{f_{sky} (2l +
      1) \Delta l} \delta_{ll'}
  \end{equation}
\item Approximation 1
\item Approximation 2
\end{itemize}

\section{Results}
For both flat and curved sky we should discuss:
\begin{itemize}
\item Simulations (sims, methods)
\item Approximation 1 - spin 0
\item Approximation 1 - spin 2
\item Approximation 2
\item Naive
\end{itemize}

For both flat and curved plots:
\begin{itemize}
\item Cov Naive
\item Cov approx 1
\item Cov approx 2
\item Cov approx 2 + deprojection
\end{itemize}

Plots:
\begin{itemize}
\item Plot $\chi^2$
\item KS($\chi^2$)
\item Eigenvalues
\end{itemize}

In this section we will show that our approximation is good and reliable; i.e.
that can be used to obtain the cosmological parameters within the same error
as using the covariance matrix from simulations. 

In order to generate the simulated $\cl$ we computed the correlations between
Gaussian fields obtained from a fiducial power spectra. The covariance
matrices were obtained from 20000 simulations, for the band powers determined
by the fraction of sky observed and the maximum band power we were able to
recover the fiducial power spectra for; i.e. $\sim 2 \times 512$. This
corresponds to $l_{\mbox{bpw}} = 1023$. For the lecture of the sky maps and
masks we used \textit{HEALPix}\footnote{\url{https://healpix.jpl.nasa.gov/}}
and
\textit{NaMaster}\footnote{\url{https://github.com/LSSTDESC/NaMaster}}~\cite{2018arXiv180909603A}
for the computation of the pseudo-$\cl$ and the covariances. Our code is
publicly available~\footnote{\url{https://github.com/damonge/PCLCovariance}}.

The same results are obtained even in the presence of foregrounds. In
particular, we tested the case with 100 foregrounds both at low scales and
large scales, adding a mock power spectra computed as $\clf = A (l +
1)^{\beta}$. Here, $A$ was fixed so that the ratio of the foreground power
spectra and the theoretical one ($\clth$) was $\clf/\clth = 0.1$ at $l=400$
and $\beta$ was randomly chosen from $U[-3, -1)$ for large scale effects and
fixed to $\beta = 0$ for small scale ones.

Apart from checking that we recover the same cosmological predictions from the
covariance matrices from both the analytical approximation and the
simulations, we studied the differences between them.

In this sense, one can see in Fig.~\ref{fig:TTTT_EEEE_chi2} that, we fully
recover the $\chi^2$ distribution (defining $\chi^2 = \cl - \langle \cl
\rangle C^{-1} \cl - \langle \cl \rangle$) for the TTTT case; whereas for the
worst case (i.e. EEEE) we are able to recover its shape, although sifted
toward lower values. This might be consequence of the fact that the inverse of
the covariance matrix is biased. It is interesting to note that even
the approximation of the mixing matrix as that of the case with spin 0, gives
good results. The eigenvalues of the covariance matrix
(Fig.~\ref{fig:TTTT_EEEE_eigv}) are also recovered within the 1\%, for all
scales in the TTTT case, and for the smaller scales in the EEEE case. Finally,
the analytical approximations are shown to describe the scale coupling (see
Fig.~\ref{fig:TTTT_rows} that comes from the fact we are masking some regions
of the sky.

\begin{figure*} %[htb]
  \centering
  \includegraphics[width=\columnwidth]{./figures/run_sph_ALL_TTTT_chi2.png}~
  \includegraphics[width=\columnwidth]{./figures/run_sph_ALL_EEEE_chi2.png}
  \caption{Comparison of the distributions found using different
    covariances for the TTTT (left) and EEEE (right) cases.}
  \label{fig:TTTT_EEEE_chi2}
\end{figure*}

\begin{figure*} %[htb]
  \centering
  \includegraphics[width=\columnwidth]{./figures/run_sph_ALL_TTTT_reldev_eigval.png}~
  \includegraphics[width=\columnwidth]{./figures/run_sph_ALL_EEEE_reldev_eigval.png}
  \caption{Comparison of the covariance matrix eigenvalues for the TTTT (left)
    and EEEE (right) cases.} 
  \label{fig:TTTT_EEEE_eigv}
\end{figure*}

\begin{figure} %[htb]
  \centering
  \includegraphics[width=\columnwidth]{./figures/run_sph_ALL_TTTT_rows_cov_matrix.png}~
  \caption{Mask induced scale correlations for the TTTT case.}
  \label{fig:TTTT_rows}
\end{figure}

The goodness of the approximation is also seen in the correlation matrices.
The subtraction of the correlation matrix from the simulations and that from
the best analytical approximation (which we have just seen gives almost same
results as the spin-0 one) shows no structure but for the case of the larger
scales of the EEEE modes (see Fig.~\ref{fig:TTTT_EEEE_corr}).

\begin{figure*} %[htb]
  \centering
  \includegraphics[width=\columnwidth]{./figures/run_sph_Efstathiou_TTTT_correlation_difference.png}~
  \includegraphics[width=\columnwidth]{./figures/run_sph_Efstathiou_EEEE_correlation_difference.png}
  \caption{Differences between the simulations and analytical approximation of
    the correlation matrices for the TTTT (left) and EEEE (right) cases.}
  \label{fig:TTTT_EEEE_corr}
\end{figure*}

These approximations do not work well for the B-modes, though. We can see in
Fig.~\ref{fig:BBBB} that we are not able to recover with accuracy the first
diagonal elements.


\begin{figure} %[htb]
  \centering
  \includegraphics[width=\columnwidth]{./figures/run_sph_ALL_BBBB_check_diagonal_terms_4.png}
  \caption{The analytical approximation are not able to reproduce accurately
    the terms involving the B-modes. Here we show the most extreme case, the
    corresponding to the BBBB modes.}
  \label{fig:BBBB}
\end{figure}


% The resulting power spectra was then used to generate a map of the sky and
% two random fields (one of spin-0 and other of spin-2), in turn. Their
% correlations give  are used to obtain the simulated power spectra. In order to
% find the real power spectra, it is necessary to subtract the contribution of
% the mask, which mixes the closest modes:
% \begin{equation}
%   C^{obs}_l = \sum_{l'} M_{ll'} C_{l'}\,
% \end{equation}
% where $M$ depends on the mask. In general, $M$ is not invertible and, in order
% to be able to recover the true power spectra, $C_l$, one needs to bin the
% $l$-space. The bin width is given by the characteristics of the window
% function and must be, approximately, of the size of the range of the mixed
% modes. That way, each $\tilde C_l$ is almost independent of the others
% $\tilde C_{l'}$, and $M$ is invertible.


\section{Discussion}\label{sec:discussion}


\section*{Acknowledgements}
We would like to thank Eva-Maria Mueller for useful discussion. CGG is
supported the Spanish grant BES-2016-077038, partially funded by the ESF and by
AYA2015-67854-P from the Ministry of Industry, Science and Innovation of Spain
and the FEDER funds. He was partially supported by a Balzan Fellowship while
in Oxford. He would like to thank New College and the Department of Physics at
Oxford for their hospitality. DA acknowledges support from STFC through an
Ernest Rutherford Fellowship, grant reference ST/P004474/1.

\setlength{\bibhang}{2.0em}
\setlength\labelwidth{0.0em}
\bibliography{paper.bib}

\end{document}
